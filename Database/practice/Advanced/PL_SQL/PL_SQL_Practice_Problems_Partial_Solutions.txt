
-- SOLUTION OF PRACTICE PROBLEM 1

CREATE OR REPLACE FUNCTION IS_TOP_N_EMP(EID IN NUMBER, N IN NUMBER)
RETURN NUMBER IS
	--EID NUMBER; -- EMPLOYEE_ID
	--N NUMBER;  --TOP N
	FLAG NUMBER;
BEGIN 
	FLAG := 0;
	FOR R IN 
		(SELECT EMPLOYEE_ID 
		FROM EMPLOYEES E1  
		WHERE DEPARTMENT_ID = (SELECT DEPARTMENT_ID FROM EMPLOYEES WHERE EMPLOYEE_ID = EID)
		AND (SELECT COUNT(*) FROM EMPLOYEES E2 WHERE E2.SALARY > E1.SALARY AND E2.DEPARTMENT_ID = E1.DEPARTMENT_ID) < N)
	LOOP  
		IF EID = R.EMPLOYEE_ID THEN 
			FLAG := 1;
		END IF;
		--DBMS_OUTPUT.PUT_LINE(R.EMPLOYEE_ID);
	END LOOP;

	RETURN FLAG;
END;




SELECT EMPLOYEE_ID, IS_TOP_N_EMP(EMPLOYEE_ID, 3)
FROM EMPLOYEES;


DECLARE 
BEGIN
	DBMS_OUTPUT.PUT_LINE(IS_TOP_N_EMP(117, 3) );
END; 
/

SELECT IS_TOP_N_EMP(115, 3) FROM DUAL;




-- SOLUTION OF PRACTICE PROBLEM 2

DECLARE
	JID VARCHAR2(20);
	JOIN_DATE DATE;
	SERVICE_LENGTH NUMBER;
	MAX_SERVICE_LENGTH NUMBER;
	MAX_SERVICE_LENGTH2 NUMBER;
	MAX_EID NUMBER;
BEGIN
	--SEARCH EMPLOYEES 
	JID := 'ST_CLERK';
	MAX_SERVICE_LENGTH := 0;
	MAX_EID := 0;
	FOR R IN (SELECT * FROM EMPLOYEES WHERE JOB_ID = JID)
	LOOP 
		SELECT NVL(MAX(END_DATE),R.HIRE_DATE) INTO JOIN_DATE FROM JOB_HISTORY WHERE EMPLOYEE_ID = R.EMPLOYEE_ID;
		SERVICE_LENGTH := SYSDATE - JOIN_DATE - 1;
		IF SERVICE_LENGTH > MAX_SERVICE_LENGTH THEN
			MAX_SERVICE_LENGTH := SERVICE_LENGTH;
			MAX_EID := R.EMPLOYEE_ID;
		END IF;
	END LOOP;

	SELECT NVL(MAX(END_DATE - START_DATE),0) INTO MAX_SERVICE_LENGTH2 FROM JOB_HISTORY WHERE JOB_ID = JID;
	IF MAX_SERVICE_LENGTH2 > MAX_SERVICE_LENGTH THEN
		DBMS_OUTPUT.PUT_LINE(MAX_SERVICE_LENGTH2);
	ELSE 
		DBMS_OUTPUT.PUT_LINE(MAX_SERVICE_LENGTH);
	END IF;
END;





-- SOLUTION OF PRACTICE PROBLEM 3

CREATE TABLE TEMP_EMPLOYEES
(
EMPLOYEE_ID NUMBER,
JOB_ID VARCHAR2(50),
SALARY NUMBER
);

CREATE OR REPLACE PROCEDURE TRANSFER(EID IN NUMBER, JID IN VARCHAR2) IS 
	T VARCHAR2(100);
BEGIN 
	INSERT INTO TEMP_EMPLOYEES VALUES (EID, JID, 10000);
END;
/

DECLARE 
	T VARCHAR2(100);
BEGIN
	TRANSFER(125,'ST_MAN');
END; 
/

SELECT JOB_ID FROM EMPLOYEES WHERE EMPLOYEE_ID = 125;

SELECT DEPARTMENT_ID, EMPLOYEE_ID, SALARY, JOB_ID  FROM EMPLOYEES 
ORDER BY DEPARTMENT_ID 